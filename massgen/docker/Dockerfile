# MassGen MCP Runtime Environment
# Provides isolated execution environment for MCP servers with command execution support
# Base image: Python 3.11 slim for balance of features and size

FROM python:3.11-slim

# Metadata
LABEL maintainer="MassGen Team"
LABEL description="Isolated runtime environment for MassGen MCP servers"
LABEL version="1.0.0"

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive

# Install system dependencies
# - git: Version control operations
# - curl: HTTP operations and downloads
# - nodejs/npm: Node.js command execution
# - build-essential: Compiling Python packages with C extensions
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    ca-certificates \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20.x (LTS)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && rm -rf /var/lib/apt/lists/*

# Create application directory
WORKDIR /app

# Copy MCP server implementations
# These will be mounted or copied at runtime
RUN mkdir -p /app/servers

# Install Python dependencies
# Core requirements: fastmcp, ag2 for MCP server infrastructure
# Common tools: pytest, requests, pandas for typical agent tasks
RUN pip install --no-cache-dir \
    'fastmcp>=2.12.3' \
    'ag2>=0.9.10' \
    'pytest>=7.0.0' \
    'requests>=2.31.0' \
    'numpy>=1.24.0' \
    'pandas>=2.0.0'

# Create workspace and context directories
# These will be mounted as volumes at runtime
RUN mkdir -p /workspace /context /temp_workspaces

# Set workspace as default working directory
WORKDIR /workspace

# Setup non-root user for security (optional but recommended)
# Agents run as this user to prevent privilege escalation
RUN useradd -m -u 1000 -s /bin/bash massgen && \
    chown -R massgen:massgen /workspace /context /temp_workspaces /app

# Switch to non-root user
USER massgen

# Default command: Print information (will be overridden at runtime)
CMD ["python", "--version"]
