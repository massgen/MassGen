name: Release Documentation Automation

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v0.0.29

permissions:
  contents: write
  pull-requests: write

jobs:
  verify-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Processing release: $TAG"

      - name: Verify release documentation exists
        id: verify
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          DOCS_DIR="docs/releases/$TAG"

          echo "ðŸ” Checking for required documentation in $DOCS_DIR..."

          MISSING=""

          if [ ! -f "$DOCS_DIR/features-overview.md" ]; then
            echo "âŒ Missing: $DOCS_DIR/features-overview.md"
            MISSING="$MISSING features-overview.md"
          else
            echo "âœ… Found: features-overview.md"
          fi

          if [ ! -f "$DOCS_DIR/release-notes.md" ]; then
            echo "âŒ Missing: $DOCS_DIR/release-notes.md"
            MISSING="$MISSING release-notes.md"
          else
            echo "âœ… Found: release-notes.md"
          fi

          if [ -n "$MISSING" ]; then
            echo "âŒ Release documentation incomplete!"
            echo "Missing files:$MISSING"
            echo "Please create the required documentation before tagging:"
            echo "  - $DOCS_DIR/features-overview.md (~100-150 lines)"
            echo "  - $DOCS_DIR/release-notes.md (400+ lines)"
            exit 1
          fi

          echo "âœ… All required documentation found!"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run README update script
        id: update_readme
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          echo "ðŸ“ Running update script for $TAG..."

          python scripts/update_readme_release.py "$TAG"

          if git diff --quiet README.md; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No changes to README.md (may already be updated)"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… README.md updated successfully"
          fi

      - name: Check for changes
        id: check_changes
        run: |
          if [ "${{ steps.update_readme.outputs.changes }}" = "false" ]; then
            echo "ðŸ“Œ README.md already up to date, skipping commit"
            exit 0
          fi

      - name: Configure git
        if: steps.update_readme.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update branch and PR
        if: steps.update_readme.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          BRANCH="docs/readme-update-$TAG"

          echo "ðŸŒ¿ Creating branch: $BRANCH"
          git checkout -b "$BRANCH"

          echo "ðŸ“ Committing changes..."
          git add README.md
          git commit -m "docs: update README for $TAG release

          - Added What's New section for $TAG
          - Archived previous release to Previous Releases
          - Auto-generated by release-docs-automation workflow"

          echo "â¬†ï¸  Pushing branch..."
          git push origin "$BRANCH"

          echo "ðŸ”„ Creating pull request..."
          gh pr create \
            --title "ðŸ“ Update README for $TAG release" \
            --body "## Automated README Update for $TAG

          This PR was automatically generated by the release documentation automation workflow.

          ### Changes
          - âœ… Added 'What's New in $TAG' section to README.md
          - âœ… Archived previous release to 'Previous Releases' section
          - âœ… Updated links to release documentation

          ### Verification
          - Release documentation verified: âœ…
            - \`docs/releases/$TAG/features-overview.md\`
            - \`docs/releases/$TAG/release-notes.md\`

          ### Next Steps
          1. Review the changes in README.md
          2. Merge this PR to complete the release process
          3. Release will be published with updated README

          ---
          ðŸ¤– Generated by: \`.github/workflows/release-docs-automation.yml\`" \
            --base main \
            --head "$BRANCH" \
            --label "documentation" \
            --label "automated"

          echo "âœ… Pull request created!"

      - name: Summary
        if: always()
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          echo "## ðŸ“‹ Release Documentation Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** $TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outcome }}" = "success" ]; then
            echo "âœ… Documentation verification: **PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "  - features-overview.md found" >> $GITHUB_STEP_SUMMARY
            echo "  - release-notes.md found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Documentation verification: **FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "  - See job logs for missing files" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.update_readme.outputs.changes }}" = "true" ]; then
            echo "âœ… README update: **COMPLETED**" >> $GITHUB_STEP_SUMMARY
            echo "  - Pull request created for review" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.update_readme.outputs.changes }}" = "false" ]; then
            echo "â„¹ï¸ README update: **SKIPPED** (already up to date)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ README update: **NOT RUN** (verification failed)" >> $GITHUB_STEP_SUMMARY
          fi
